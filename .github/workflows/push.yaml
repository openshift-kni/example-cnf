name: PR Validation

on:
  push:
    branches:
      - main

env:
  REGISTRY: quay.io

defaults:
  run:
    shell: bash

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Dump GitHub context
        id: github_context_step
        run: echo '${{ toJSON(github) }}'

      - name: Log in to Quay.io
        uses: redhat-actions/podman-login@v1
        with:
          username: ${{ secrets.QUAY_USER }}
          password: ${{ secrets.QUAY_TOKEN }}
          registry: ${{ env.REGISTRY }}

      - name: Build All
        run: |
          set -x
          SHA=$(git rev-parse --short HEAD)
          DATE=$(date --utc +%Y%m%d%H%M)
          make version
          make all SHA=${SHA} DATE=${DATE} RELEASE=1 FORCE=true
